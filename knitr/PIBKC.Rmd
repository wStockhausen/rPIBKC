---
title: "PIBKC Stock Assessment Appendix"
author: "William Stockhausen"
date: "July 18, 2015"
output: pdf_document
---
```{r,echo=FALSE}
setwd("../test")
```

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.
## Introduction
This is an appendix to the stock assessment chapter for the Pribilof Islands blue king crab stock (PIBKC). It outlines and presents results for status determination (is the stock overfished?, is overfishing occurring?) using the rPIBKC R package developed by William Stockhausen (NOAA/NMFS/AFSC). The rPIBKC package (source code and R package) is available under source control at URL??

```{r,echo=FALSE}
##set knitr options for subsequent chunks
knitr::opts_chunk$set(fig.width = 7, fig.height = 4, echo = FALSE, error=FALSE, message=FALSE, warning=FALSE)
```

```{r,echo=FALSE}
##load required packages
require(rPIBKC);
require(wtsUtilities);
require(reshape2);
require(xtable);
##set counters (fig, tbl)
fig<-0;
tbl<-0;
## set values for input variables
assYr=2014;
recentYear=1990;
srvData=NULL;
fshData=NULL;
yrsForBmsy=c(1980:1984,1990:1997);
nYrsSrvAvg=3;
nYrsTheta=3;
M=0.18;
t.sf=3/12;
t.fm=4/12;
hm.pot=0.5;
hm.trl=0.8;
pct.male=0.5;
gamma=1.0;
alpha=0.1;
beta=0.25;
pdfType='lognormal';
ci=0.95;
verbose=FALSE;
showPlot=FALSE;
```

#Data  
##Fishery data  
```{r,echo=FALSE}
##select fishery data file
fnF<-selectFile(ext="csv",caption="Select csv file with PIBKC fishery data")
fshData<-getFisheryData(fnF);
```
Fishery data from file "`r fnF`" (Table `r tbl<-tbl+1; tbl`) were used for this assessment.

##Survey data
```{r,echo=FALSE}
##select survey data file
fnS<-selectFile(ext="csv",caption="Select csv file with PIBKC survey data")
srvData<-getSurveyData(fnS);
```
Survey data from file "`r fnS`" (Table `r tbl<-tbl+1; tbl`) was used for the assessment.

The fishery and survey data are compared in the following plots:
```{r,echo=FALSE}
##create plots of raw fishery and survey data
knitr::opts_chunk$set(fig.width = 7, fig.height = 4)
res<-plotRawData(srvData,fshData,yr2=recentYear,pdfType=pdfType,ci=ci,showPlot=FALSE);
plts.RawData<-res$plots;
```

```{r,echo=FALSE}
fig<-fig+1;
print(plts.RawData$pS1);
```
Fig. `r fig`. Survey biomass time series components. Confidence intervals shown are `r ci`% CIs, assuming `r pdfType` error distributions.  

```{r,echo=FALSE}
fig<-fig+1;
print(plts.RawData$pS2);
```
Fig. `r fig`. Recent (since `r recentYear`) survey biomass time series components. Confidence intervals shown are `r ci`% CIs, assuming `r pdfType` error distributions.

```{r,echo=FALSE}
fig<-fig+1;
print(plts.RawData$pS3);
```
Fig. `r fig`. Log10-scale survey biomass time series. Confidence intervals shown are `r ci`% CIs, assuming `r pdfType` error distributions.

```{r,echo=FALSE}
fig<-fig+1;
print(plts.RawData$pF1);
```
Fig. `r fig`. Fishery time series components.

```{r,echo=FALSE}
fig<-fig+1;
print(plts.RawData$pF2);
```
Fig. `r fig`. Recent (since `r recentYear`) fishery time series.

##Smoothed survey data
Inverse variance (IV) and a kalman filter/random effects model (RE) were used to smooth the mature male biomass time series from the survey data.
```{r,echo=FALSE}
srvData.IV<-surveyAveraging.IV(srvData,pdfType=pdfType,ci=ci,showPlot=FALSE);
srvData.RE<-surveyAveraging.RE(srvData,pdfType=pdfType,ci=ci,showPlot=FALSE);
idx<-srvData.RE$type=='RE';
dfr<-rbind(srvData.IV,srvData.RE[idx,]);
plts.AvgdData<-plotAvgdData(dfr,yr2=recentYear,showPlot=FALSE);
```

```{r,echo=FALSE}
fig<-fig+1;
print(plts.AvgdData$arScl1);
```
Fig. `r fig`. Arithmetic-scale raw and smoothed survey mature male biomass time series. Confidence intervals shown are `r ci`% CIs, assuming `r pdfType` error distributions.

```{r,echo=FALSE}
fig<-fig+1;
print(plts.AvgdData$arScl2);
```
Fig. `r fig`. Arithmetic-scale raw and smoothed survey mature male biomass time series, since `r recentYear`. Confidence intervals shown are `r ci`% CIs, assuming `r pdfType` error distributions.

```{r,echo=FALSE}
fig<-fig+1;
print(plts.AvgdData$lnScl);
```
Fig. `r fig`. Log10-scale raw and smoothed survey mature male biomass time series. Confidence intervals shown are `r ci`% CIs, assuming `r pdfType` error distributions.

##Status Determination
Pribilof Islands blue king crab falls into Tier 4 for status determination and OFL setting. For Tier 4 stocks, stock status is assessed with respect to a proxy for $B_{MSY}$ based on average MMB at mating, where the averaging is over some time span during which the stock is assumed to have been ???. For PIBKC, the Science and Statistical Committee (SSC) of the North Pacific Fishery Management Council (NPFMC) has determined the time span for averaging to be the years 1980-1984 and 1990-1997.

For Tier 4 stocks, $B_{MSY}$ is the average MMB at mating over some specified time interval. For PIBKC, the variances associated with annual survey estimates of MMB are so large that, prior to estimating annual MMBs at mating and averaging over the specified time span, the survey MMB time series is first smoothed in some fashion to reduce overall variability,To estimate MMB at mating, the inverse variance-averaged time series of MMB at the time of the survey was projected forward to the time of mating, accounting for both natural and fishing mortality. The estimated time series of MMB at the time of the survey (the inverse-averaged time series), at the time of the fishery, and at the time of mating are shown in Fig. `r fig<-fig+1; fig`.
```{r, echo=FALSE}
    ##calculate MMB at mating time series using the IV-averaged survey MMB
    idx<-srvData.IV$type=='IV';
    lstMMB.IV<-calcMMBMating(fshData,
                              srvData.IV[idx,],
                              avgType="IV",
                              M=M,
                              t.sf=t.sf,
                              t.fm=t.fm,
                              hm.pot=hm.pot,
                              hm.trl=hm.trl,
                              pct.male=pct.male);
    mmbSrvCurr.IV<-lstMMB.IV$mmbSrv[as.character(assYr)];
    ##calculate MMB at mating time series using the RE-smoothed survey MMB
    idx<-srvData.RE$type=='RE';
    lstMMB.RE<-calcMMBMating(fshData,
                              srvData.REM[idx,],
                              avgType="RE",
                              M=M,
                              t.sf=t.sf,
                              t.fm=t.fm,
                              hm.pot=hm.pot,
                              hm.trl=hm.trl,
                              pct.male=pct.male);
    mmbSrvCurr.RE<-lstMMB.RE$mmbSrv[as.character(assYr)];
```
The estimate of current (`r assYr`) MMB at the time of the survey is `r mmbSrvCurr` thousand t.  

```{r, echo=FALSE}
    print(lstMMB$plots$MMB);
```
Fig. `r fig`. Estimated time series for MMB at the time of the survey (the inverse-averaged time series), at the time of the fishery, and at the time of mating.    

```{r, echo=FALSE}
    ##calculate Bmsy by averaging MMB at mating over specified time intervals
    Bmsy.IV<-calcBmsy(lstMMB.IV$mmbMat,years=yrsForBmsy);
    Bmsy.RE<-calcBmsy(lstMMB.IV$mmbMat,years=yrsForBmsy);
````
Averaging estimated MMB at mating over the period [1980-1984,1990-1997] yields $B_{MSY_{proxy}} = `r Bmsy`$ thousand t.  

Whether or not the stock is in an overfished condition is determined by the ratio $r = B_{curr}/B_{MSY}$, where $B_{curr}$ is the "current" MMB at mating for the assessment year. If $r < 0.5$, then stock is overfished. The "current" MMB at mating for assessment year y is MMB on Feb. 15, y+1; it must be projected forward from the "current" survey MMB (calculated above), taking into account any natural mortality and *projected* fishing effects occurring prior to spawning.
```{r, echo=FALSE}
    ##calculate 'theta', the average discard mortality exploitation rate
    theta<-calcTheta(lstMMB,assYr=assYr,n=nYrsTheta)[2];
    if (verbose) cat("theta:",theta,'\n')
```
$\theta = `r theta`$.  

```{r, echo=FALSE}
    #calculate OFL quantities
    lstOFL.inputs<-list(mmbSrvCurr=mmbSrvCurr,
                        Bmsy=Bmsy,
                        theta=theta,
                        M=M,
                        gamma=gamma,
                        alpha=alpha,
                        beta=beta,
                        t.sf=t.sf,
                        t.fm=t.fm);
    lstOFL<-calcOFL(mmbSrvCurr,
                    Bmsy,
                    theta,
                    M=M,
                    gamma=gamma,
                    alpha=alpha,
                    beta=beta,
                    t.sf=t.sf,
                    t.fm=t.fm);
    if (verbose) cat('retOFL:',lstOFL$retOFL,"dscOFL:",lstOFL$dscOFL,"totOFL:",lstOFL$retOFL+lstOFL$dscOFL,'\n')
    if (verbose) cat('Fofl:',lstOFL$Fofl,"prjMMB:",lstOFL$prjMMB,'\n')
```

#Tables
Table `r tbl<-tbl+1; tbl`. Input fishery data.
```{r, results='asis', echo=FALSE, message=FALSE}
##create table of raw, averaged survey data
mdfr<-melt(dfr,idvars=c('year','type'),measure.vars=c('value','lci','uci'));
dfrp<-dcast(mdfr,year~type+variable,value.var='value')
dfrp$year<-as.character(dfrp$year)
xtbl.FshData<-xtable(dfrp)
print(xtbl.FshData,type='latex',comment=FALSE,include.rownames=FALSE);
```

Table `r tbl<-tbl+1; tbl`. Input ("raw") survey data.
```{r, results='asis', echo=FALSE, message=FALSE}
##create table of raw survey data
mdfr<-melt(dfr,idvars=c('year','type'),measure.vars=c('value','lci','uci'));
dfrp<-dcast(mdfr,year~type+variable,value.var='value')
dfrp$year<-as.character(dfrp$year)
xtbl.AvgSrvData<-xtable(dfrp)
print(xtbl.AvgSrvData,type='latex',comment=FALSE,include.rownames=FALSE);
```

Table `r tbl<-tbl+1; tbl`. A comparison of smoothed estimates for MMB at the time of the survey.
```{r, results='asis', echo=FALSE, message=FALSE}
##create table of raw, averaged survey MMB
mdfr<-melt(dfr,idvars=c('year','type'),measure.vars=c('value','lci','uci'));
dfrp<-dcast(mdfr,year~type+variable,value.var='value')
dfrp$year<-as.character(dfrp$year)
xtbl.AvgSrvData<-xtable(dfrp)
print(xtbl.AvgSrvData,type='latex',comment=FALSE,include.rownames=FALSE);
```

